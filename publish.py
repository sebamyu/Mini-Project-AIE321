import pandas as pd
from sqlalchemy import create_engine
import gspread
from gspread_dataframe import set_with_dataframe
import time

# ==========================================
# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Configuration
# ==========================================
# ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Database (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
DB_CONN_STR = 'postgresql://postgres:password@127.0.0.1:5432/postgres'

# ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏∏‡∏ç‡πÅ‡∏à ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏∑‡πà‡∏≠ Google Sheet ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
CREDENTIALS_FILE = 'credentials.json'
SHEET_NAME = 'Hotel Data Dashboard'  # <--- ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏ô Google Drive ‡πÄ‡∏õ‡πä‡∏∞‡πÜ

def main():
    print("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ Publish (‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô Cloud)...")

    # ---------------------------------------------------------
    # Step 1: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets
    # ---------------------------------------------------------
    try:
        print("üîë ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Å‡∏±‡∏ö Google...")
        gc = gspread.service_account(filename=CREDENTIALS_FILE)
        
        # ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå Google Sheets
        sh = gc.open(SHEET_NAME)
        print(f"‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå '{SHEET_NAME}' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
    except Exception as e:
        print(f"‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: {e}")
        print("üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Å‡∏î Share ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ Email ‡πÉ‡∏ô credentials.json")
        return

    # ---------------------------------------------------------
    # Step 2: ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Database
    # ---------------------------------------------------------
    engine = create_engine(DB_CONN_STR)

    # [A] ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ (Summary) - ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏•‡πá‡∏Å ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß
    try:
        print("üìä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 'production.monthly_summary'...")
        df_summary = pd.read_sql("SELECT * FROM production.monthly_summary", engine)
        
        # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Worksheet (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)
        try:
            w_sum = sh.worksheet("Monthly_Summary")
        except:
            w_sum = sh.add_worksheet("Monthly_Summary", rows=1000, cols=20)
        
        print(f"‚òÅÔ∏è  ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ {len(df_summary)} ‡πÅ‡∏ñ‡∏ß...")
        w_sum.clear() # ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
        set_with_dataframe(w_sum, df_summary) # ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
        print("‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Summary ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
        
    except Exception as e:
        print(f"‚ö†Ô∏è ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Summary: {e}")

    # [B] ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Cleaned Data) - ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á!
    # Google Sheets ‡∏°‡∏µ‡∏à‡∏≥‡∏Å‡∏±‡∏î Cell (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 10 ‡∏•‡πâ‡∏≤‡∏ô‡πÄ‡∏ã‡∏•‡∏•‡πå ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏à‡∏∞‡∏≠‡∏∑‡∏î‡∏°‡∏≤‡∏Å)
    try:
        print("üìö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 'production.cleaned_hotel_bookings'...")
        
        # --- ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ: ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Limit) ---
        # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏£‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö ‡πÉ‡∏´‡πâ‡∏•‡∏ö "LIMIT 5000" ‡∏≠‡∏≠‡∏Å
        query = "SELECT * FROM production.cleaned_hotel_bookings LIMIT 5000" 
        df_clean = pd.read_sql(query, engine)
        
        try:
            w_clean = sh.worksheet("Cleaned_Data")
        except:
            w_clean = sh.add_worksheet("Cleaned_Data", rows=len(df_clean)+100, cols=len(df_clean.columns)+5)
            
        print(f"‚òÅÔ∏è  ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î {len(df_clean)} ‡πÅ‡∏ñ‡∏ß (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)...")
        w_clean.clear()
        set_with_dataframe(w_clean, df_clean)
        print("‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Cleaned Data ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
        
    except Exception as e:
        print(f"‚ö†Ô∏è ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Cleaned Data: {e}")

    print("üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô Cloud ‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥ Dashboard ‡∏ï‡πà‡∏≠‡πÑ‡∏õ")

if __name__ == "__main__":
    main()